<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Unity+Jenkins实现自动化打包 | tiger</title><meta name="description" content="Unity+Jenkins实现自动化打包"><meta name="keywords" content="Android,Unity,iOS,Jenkins"><meta name="author" content="tiger"><meta name="copyright" content="tiger"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/my_favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Unity+Jenkins实现自动化打包"><meta name="twitter:description" content="Unity+Jenkins实现自动化打包"><meta name="twitter:image" content="https://s1.ax1x.com/2020/03/12/8eGq29.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Unity+Jenkins实现自动化打包"><meta property="og:url" content="https://chenghu.online/posts/a27a69b1/"><meta property="og:site_name" content="tiger"><meta property="og:description" content="Unity+Jenkins实现自动化打包"><meta property="og:image" content="https://s1.ax1x.com/2020/03/12/8eGq29.jpg"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      now = new Date();
      hour = now.getHours();
      isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://chenghu.online/posts/a27a69b1/"><link rel="prev" title="Unity 图集优化" href="https://chenghu.online/posts/cf36b965/"><link rel="next" title="Unity 调用iOS原生实现内购" href="https://chenghu.online/posts/fb902642/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://chenghu.online/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: false,
  isFontAwesomeV5: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false
}</script><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="tiger" type="application/atom+xml">
</head><body><canvas class="fireworks"></canvas><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/my_avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">17</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">8</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">8</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-coffee"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 更多</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li><li><a class="site-page" href="/games/"><i class="fa-fw fa fa-gamepad"></i><span> Game</span></a></li></ul></div></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://s1.ax1x.com/2020/03/12/8eGq29.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">tiger</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-coffee"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 更多</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li><li><a class="site-page" href="/games/"><i class="fa-fw fa fa-gamepad"></i><span> Game</span></a></li></ul></div></div></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Unity+Jenkins实现自动化打包</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-03-12<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-03-26</time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/">开发工具</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>评论数:</span><a href="/posts/a27a69b1/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count comment-count" data-xid="/posts/a27a69b1/" itemprop="commentCount"></span></a></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>两年 两年 你知道这两年我是怎么过的吗？天天打包测试，你知道有多好玩吗！哈哈哈，开个玩笑。作为一名Unity开发工程师，在开发、测试、发布环节都需要我们导出安卓或者苹果安装包，今年我们公司使用的苹果打包机是mac mini<del>（为了省钱，哈哈）</del>，本身打包速度就非常慢，更何况安卓平台需要发布多渠道，要经常替换SDK文件，苹果平台则需要先处理XCode工程，才能进行导出，全部手动处理会非常容易出错，简直是雪上加霜。所以今天总结一下我是如何使用Unity+Jenkins来解决我这些烦恼的，希望对你也可以有帮助</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>实现原理比较简单，主要还是需要依靠操作系统的命令行。大部分功能就算不使用Jenkins，也可以实现。使用Jenkins主要是因为它给我们提供了一套可视化界面还有一系列的插件，帮助我们简化了操作流程，方便维护。</p>
<h2 id="一、如何安装Jenkins"><a href="#一、如何安装Jenkins" class="headerlink" title="一、如何安装Jenkins"></a>一、如何安装Jenkins</h2><p>我是在Mac上安装的<a href="https://jenkins.io/zh/" target="_blank" rel="noopener">Jenkins</a>，因为我们在Windows上不可以导出苹果包，但是在Mac上我们可以导出安卓包!<br>在Mac上我们可以通过.pkg、brew、.war三种方式进行安装</p>
<ul>
<li>.pkg安装程序，安装方式：双击安装程序即可安装；不推荐使用。好处：可以通过桌面图标启动Jenkins，坏处：没有文件操作权限！根本就没法用！</li>
<li>brew命令行，安装方式：在终端输入<code>brew install jenkins</code>。推荐使用。好处：安装后可以在终端直接输入<code>Jenkins</code>来启动Jenkins，坏处：需要安装<a href="https://brew.sh/index_zh-cn" target="_blank" rel="noopener">brew</a>工具</li>
<li>.war包，推荐使用。好处：方便更新，直接替换.war文件即可，坏处：启动时不方便，每次都需要在终端用<code>java -jar war所在路径/jenkins.war</code>启动，当然你可以使用<code>Shell</code>脚本设置开机自启，但是还是太麻烦了！</li>
</ul>
<p>注意：Jenkins依赖Java环境，并且Jenkins的下载速度较慢，容易失败，建议翻墙下载</p>
<h2 id="二、如何登录Jenkins"><a href="#二、如何登录Jenkins" class="headerlink" title="二、如何登录Jenkins"></a>二、如何登录Jenkins</h2><ul>
<li>首先检查Jenkins是否启动，如果没有启动，需要根据安装方式先进行启动</li>
<li>然后打开浏览器输入<code>localhost:8080（如果修改过输入修改后的ip）</code>，进入Jenkins操作界面</li>
<li>如果是第一次启动，需要先输入密码来解锁Jenkins。然后创建管理员账号后使用管理员账号登录</li>
</ul>
<h2 id="三、Jenkins插件推荐"><a href="#三、Jenkins插件推荐" class="headerlink" title="三、Jenkins插件推荐"></a>三、Jenkins插件推荐</h2><p>简要介绍一下我使用到的插件：</p>
<ol>
<li><a href="https://plugins.jenkins.io/localization-zh-cn" target="_blank" rel="noopener">Localization：Chinese(Simplified)</a> 简体中文语言包，可以汉化部分说明</li>
<li><a href="https://plugins.jenkins.io/unity3d-plugin" target="_blank" rel="noopener">Unity3d plugin</a> 增强Unity编辑器打包拓展，默认Unity项目在工作区，可以在视图显示Log</li>
<li><a href="https://plugins.jenkins.io/subversion" target="_blank" rel="noopener">Subversion</a> SVN插件，可以在任务流水线中添加SVN模块，执行项目导出、还原、更新等操作</li>
</ol>
<p>注意：<strong>不要在新手入门时安装任何插件</strong>，很容易下载失败，进去后会有错误，建议登录后在Manage jenkin/Manager Plugins中管理插件</p>
<h2 id="五、修改Jenkins插件配置"><a href="#五、修改Jenkins插件配置" class="headerlink" title="五、修改Jenkins插件配置"></a>五、修改Jenkins插件配置</h2><ol>
<li><a href="https://plugins.jenkins.io/unity3d-plugin" target="_blank" rel="noopener">Unity3d plugin。</a> 需要在Jenkins的Global Tool Configuration设置中添加Unity安装目录<br><img src="/" alt="unity安装路径" class="lazyload" data-src="/posts/a27a69b1/unity.png"></li>
<li><a href="https://plugins.jenkins.io/subversion" target="_blank" rel="noopener">Subversion。</a> 需要在Jenkins凭证设置中添加SVN用户名、密码<br><img src="/" alt="svn凭证" class="lazyload" data-src="/posts/a27a69b1/svn.png"> </li>
</ol>
<h2 id="六、Unity编辑器拓展打包"><a href="#六、Unity编辑器拓展打包" class="headerlink" title="六、Unity编辑器拓展打包"></a>六、Unity编辑器拓展打包</h2><h3 id="项目设置代码"><a href="#项目设置代码" class="headerlink" title="项目设置代码"></a>项目设置代码</h3><ul>
<li>通用设置<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PlayerSettings.companyName=<span class="string">"公司名称"</span></span><br><span class="line">PlayerSettings.productName =<span class="string">"产品名"</span>;</span><br><span class="line"><span class="comment">//允许屏幕上下旋转</span></span><br><span class="line">PlayerSettings.defaultInterfaceOrientation = UIOrientation.AutoRotation;</span><br><span class="line">PlayerSettings.allowedAutorotateToPortrait = <span class="literal">false</span>;</span><br><span class="line">PlayerSettings.allowedAutorotateToPortraitUpsideDown = <span class="literal">false</span>;</span><br><span class="line">PlayerSettings.allowedAutorotateToLandscapeRight = <span class="literal">true</span>;</span><br><span class="line">PlayerSettings.allowedAutorotateToLandscapeLeft = <span class="literal">true</span>;</span><br><span class="line">PlayerSettings.SetApplicationIdentifier(buildTargetGroup, <span class="string">"包名"</span>);<span class="comment">//根据打包目标平台设置包名</span></span><br><span class="line">PlayerSettings.SplashScreen.show = <span class="literal">false</span>; <span class="comment">//是否显示启动Logo</span></span><br></pre></td></tr></table></figure></li>
<li>Android平台设置<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置目标SDK版本</span></span><br><span class="line">PlayerSettings.Android.targetSdkVersion = AndroidSdkVersions.AndroidApiLevel26;</span><br><span class="line"><span class="comment">//设置不导出安卓工程</span></span><br><span class="line">EditorUserBuildSettings.androidBuildSystem=AndroidBuildSystem.Internal;</span><br><span class="line">DirectoryInfo dir = Directory.GetParent(Application.dataPath);</span><br><span class="line"><span class="comment">//配置安卓签名</span></span><br><span class="line"><span class="keyword">string</span> keystorePath = dir.ToString() + <span class="string">@"/user.keystore"</span>;<span class="comment">//签名文件路径</span></span><br><span class="line">PlayerSettings.Android.keystoreName = keystorePath;</span><br><span class="line">PlayerSettings.Android.keystorePass = <span class="string">"XXX"</span>;<span class="comment">//文件密码</span></span><br><span class="line">PlayerSettings.Android.keyaliasName = <span class="string">"XXX"</span>;<span class="comment">//key的别名</span></span><br><span class="line">PlayerSettings.Android.keyaliasPass = <span class="string">"XXX"</span>;<span class="comment">//key的密码</span></span><br></pre></td></tr></table></figure></li>
<li>iOS平台设置<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//配置苹果开发账号TeamID</span></span><br><span class="line">PlayerSettings.iOS.appleDeveloperTeamID = <span class="string">"XXX"</span>;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="项目打包代码"><a href="#项目打包代码" class="headerlink" title="项目打包代码"></a>项目打包代码</h3><ul>
<li><p>Android平台：导出为.apk</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">BuildPlayerOptions buildPlayerOptions = <span class="keyword">new</span> BuildPlayerOptions();</span><br><span class="line"><span class="keyword">string</span> dir = BuildTool.GetBuildPackageRootDir() + <span class="string">"/"</span> + <span class="string">"Android/"</span>;</span><br><span class="line"><span class="keyword">string</span> locationPathName = dir + BuildTool.GetAndroidPackageName();</span><br><span class="line">buildPlayerOptions.locationPathName = locationPathName;</span><br><span class="line">buildPlayerOptions.scenes = BuildTool.GetBuildScene();</span><br><span class="line">buildPlayerOptions.target =BuildTarget.Android;</span><br><span class="line">buildPlayerOptions.options = BuildOptions.None;</span><br><span class="line">BuildReport report = BuildPipeline.BuildPlayer(buildPlayerOptions);</span><br><span class="line">BuildSummary summary = report.summary;</span><br><span class="line"> <span class="keyword">if</span> (summary.result == BuildResult.Succeeded) &#123;</span><br><span class="line">    Debug.Log(<span class="string">"Build succeeded: "</span> + summary.totalSize + <span class="string">" bytes"</span>);</span><br><span class="line">    BuildTool.OpenFolder(dir);</span><br><span class="line">    &#125;</span><br><span class="line"> <span class="keyword">if</span> (summary.result == BuildResult.Failed) &#123;</span><br><span class="line">    Debug.Log(<span class="string">"Build failed"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>iOS平台：使用sh脚本调用XCode命令行导出ipa<br>导出XCode工程</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">BuildPlayerOptions buildPlayerOptions = <span class="keyword">new</span> BuildPlayerOptions();</span><br><span class="line"><span class="keyword">string</span> dir = BuildTool.GetBuildPackageRootDir() + <span class="string">"/"</span> + <span class="string">"iOS/"</span>;</span><br><span class="line"><span class="keyword">string</span> locationPathName = dir + BuildTool.GetXcodeProjectName();</span><br><span class="line">buildPlayerOptions.locationPathName = locationPathName;</span><br><span class="line">buildPlayerOptions.scenes = BuildTool.GetBuildScene();</span><br><span class="line">buildPlayerOptions.target = BuildTarget.iOS;</span><br><span class="line">buildPlayerOptions.options = BuildOptions.None;</span><br><span class="line">BuildReport report = BuildPipeline.BuildPlayer(buildPlayerOptions);</span><br><span class="line">BuildSummary summary = report.summary;</span><br><span class="line"><span class="comment">//构建完XCode工程后会走这里</span></span><br><span class="line"><span class="keyword">if</span> (summary.result == BuildResult.Succeeded) &#123;</span><br><span class="line">     Debug.Log(<span class="string">"Build succeeded: "</span> + summary.totalSize + <span class="string">" bytes"</span>);</span><br><span class="line">    <span class="comment">//打开文件夹</span></span><br><span class="line">    BuildTool.OpenFolder(locationPathName);</span><br><span class="line">    <span class="comment">//导出ipa</span></span><br><span class="line">    ExportIPA(locationPathName, BuildTool.GetIPAExportOptionsFilePath());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (summary.result == BuildResult.Failed) &#123;</span><br><span class="line">    Debug.Log(<span class="string">"Build failed"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>设置XCode工程</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//XCode工程打包完成时，使用代码进行设置</span></span><br><span class="line">[<span class="meta">PostProcessBuild(100)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SetXCodeProject</span>(<span class="params">BuildTarget buildTarget, <span class="keyword">string</span> path</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (buildTarget!=BuildTarget.iOS) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">string</span> projectPath = PBXProject.GetPBXProjectPath(path);</span><br><span class="line">    PBXProject project = <span class="keyword">new</span> PBXProject();</span><br><span class="line">    <span class="keyword">string</span> fileText = File.ReadAllText(projectPath);</span><br><span class="line">    project.ReadFromString((fileText));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取targetGuid</span></span><br><span class="line">    <span class="keyword">string</span> target = project.TargetGuidByName(<span class="string">"Unity-iPhone"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取plist</span></span><br><span class="line">    <span class="keyword">string</span> plistPath = path + <span class="string">"/Info.plist"</span>;</span><br><span class="line">    PlistDocument plist = <span class="keyword">new</span> PlistDocument();</span><br><span class="line">    plist.ReadFromString(File.ReadAllText(plistPath));</span><br><span class="line">    <span class="comment">//获取plist root</span></span><br><span class="line">    PlistElementDict plistDic = plist.root;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">//---业务代码，仅供参考</span></span><br><span class="line">    <span class="comment">//拷贝微信分享图标，到Resources目录下</span></span><br><span class="line">    CopyFileToXCodeProject(project, target, path,BuildTool.GetXcodeProDependentRootPath(), <span class="string">"Resources"</span>, <span class="string">"Icon.png"</span>);</span><br><span class="line">    <span class="comment">//拷贝UnityAppController脚本</span></span><br><span class="line">    CopyFileToXCodeProject(project, target, path, BuildTool.GetXcodeProDependentRootPath(), <span class="string">"Classes"</span>, <span class="string">"UnityAppController.h"</span>);</span><br><span class="line">    CopyFileToXCodeProject(project, target, path, BuildTool.GetXcodeProDependentRootPath(), <span class="string">"Classes"</span>, <span class="string">"UnityAppController.mm"</span>);</span><br><span class="line">    <span class="comment">//设置微信</span></span><br><span class="line">    SetWeiXin(path,plistDic, project, target);</span><br><span class="line">    <span class="comment">//设置语音</span></span><br><span class="line">    SetGameLink(plistDic,project, target);</span><br><span class="line">    <span class="comment">//设置其他</span></span><br><span class="line">    SetOther(path, plistDic, project, target);</span><br><span class="line">    <span class="comment"><span class="doctag">///</span>---业务代码，仅供参考</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//覆盖plist文件</span></span><br><span class="line">    File.WriteAllText(plistPath, plist.WriteToString());</span><br><span class="line">    <span class="comment">//覆盖Xcode工程</span></span><br><span class="line">    File.WriteAllText(projectPath, project.WriteToString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SetWeiXin</span>(<span class="params"><span class="keyword">string</span> xcodePath,PlistElementDict plistDic, PBXProject project, <span class="keyword">string</span> target</span>)</span> &#123;</span><br><span class="line">    <span class="comment">//1.拷贝wei文件</span></span><br><span class="line">    CopyFileToXCodeProject(project, target, xcodePath, BuildTool.GetXcodeProDependentRootPath(), <span class="string">"wei"</span>, <span class="string">"libWeChatSDK.a"</span>);</span><br><span class="line">    CopyFileToXCodeProject(project, target, xcodePath, BuildTool.GetXcodeProDependentRootPath(), <span class="string">"wei"</span>, <span class="string">"WechatAuthSDK.h"</span>);</span><br><span class="line">    CopyFileToXCodeProject(project, target, xcodePath, BuildTool.GetXcodeProDependentRootPath(), <span class="string">"wei"</span>, <span class="string">"WXApi.h"</span>);</span><br><span class="line">    CopyFileToXCodeProject(project, target, xcodePath, BuildTool.GetXcodeProDependentRootPath(), <span class="string">"wei"</span>, <span class="string">"WXApiObject.h"</span>);</span><br><span class="line">    <span class="comment">//2.Add微信 scheme       </span></span><br><span class="line">    AddURLSchemes(plistDic,<span class="string">"weixin"</span>, <span class="string">"wx5c9d9308db6097aa"</span>);</span><br><span class="line">    AddQueriesSchemes(plistDic,<span class="string">"weixin"</span>);</span><br><span class="line">    <span class="comment">//3.添加依赖库</span></span><br><span class="line">    project.AddFrameworkToProject(target, <span class="string">"SystemConfiguration.framework"</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    AddLib(project,target, <span class="string">"libz.tbd"</span>);</span><br><span class="line">    AddLib(project, target, <span class="string">"libsqlite3.0.tbd"</span>);</span><br><span class="line">    AddLib(project, target, <span class="string">"libc++.tbd"</span>);</span><br><span class="line"></span><br><span class="line">    project.AddFrameworkToProject(target, <span class="string">"Security.framework"</span>, <span class="literal">false</span>);</span><br><span class="line">    project.AddFrameworkToProject(target, <span class="string">"CoreTelephony.framework"</span>, <span class="literal">false</span>);</span><br><span class="line">    project.AddFrameworkToProject(target, <span class="string">"CFNetwork.framework"</span>, <span class="literal">false</span>);</span><br><span class="line">    project.AddFrameworkToProject(target, <span class="string">"CoreGraphics.framework"</span>, <span class="literal">false</span>);</span><br><span class="line">    <span class="comment">//4.buildsettings添加flags</span></span><br><span class="line">    project.AddBuildProperty(target, <span class="string">"OTHER_LDFLAGS"</span>, <span class="string">"-Objc"</span>);</span><br><span class="line">    project.AddBuildProperty(target, <span class="string">"OTHER_LDFLAGS"</span>, <span class="string">"-all_load"</span>);</span><br><span class="line">    <span class="comment">//5.buildsettings添加头文件和库文件搜索路径</span></span><br><span class="line">    project.AddBuildProperty(target, <span class="string">"HEADER_SEARCH_PATHS"</span>, <span class="string">"$(SRCROOT)/wei"</span>);</span><br><span class="line">    project.AddBuildProperty(target, <span class="string">"LIBRARY_SEARCH_PATHS"</span>, <span class="string">"$(SRCROOT)/wei"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SetGameLink</span>(<span class="params">PlistElementDict plistDic, PBXProject project,<span class="keyword">string</span> target</span>)</span> &#123;</span><br><span class="line">    <span class="comment">//ENABLE_BITCODE=False 关闭BitCode</span></span><br><span class="line">    project.SetBuildProperty(target, <span class="string">"ENABLE_BITCODE"</span>, <span class="string">"false"</span>);</span><br><span class="line">    <span class="comment">//允许http</span></span><br><span class="line">    <span class="keyword">var</span> atsKey = <span class="string">"NSAppTransportSecurity"</span>; PlistElementDict dictTmp = plistDic.CreateDict(atsKey); dictTmp.SetBoolean(<span class="string">"NSAllowsArbitraryLoads"</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="comment">//添加-ObjC</span></span><br><span class="line">    project.AddBuildProperty(target, <span class="string">"OTHER_LDFLAGS"</span>, <span class="string">"-ObjC"</span>);</span><br><span class="line">    <span class="comment">//添加库</span></span><br><span class="line">    AddLib(project,target, <span class="string">"libz.tbd"</span>);</span><br><span class="line">    AddLib(project,target, <span class="string">"libicucore.tbd"</span>);</span><br><span class="line"></span><br><span class="line">    project.AddFrameworkToProject(target, <span class="string">"Contacts.framework"</span>, <span class="literal">false</span>);</span><br><span class="line">    project.AddFrameworkToProject(target, <span class="string">"AddressBook.framework"</span>, <span class="literal">false</span>);</span><br><span class="line">    project.AddFrameworkToProject(target, <span class="string">"CoreTelephony.framework"</span>, <span class="literal">false</span>);</span><br><span class="line">    <span class="comment">//权限</span></span><br><span class="line">    plistDic.SetString(<span class="string">"NSMicrophoneUsageDescription"</span>, <span class="string">"沪乐麻将需要您的同意，才能使用您的麦克风用于游戏内的语音功能。"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SetOther</span>(<span class="params"><span class="keyword">string</span> xcodePath,PlistElementDict plistDic, PBXProject project, <span class="keyword">string</span> target</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 权限</span></span><br><span class="line">    plistDic.SetString(<span class="string">"NSContactsUsageDescription"</span>, <span class="string">"是否允许此App访问你的通讯录"</span>);</span><br><span class="line">    plistDic.SetString(<span class="string">"NSLocationUsageDescription"</span>, <span class="string">"位置权限将会在您创建或加入房间后应用，允许使用后可查自己和房间中其他玩家的位置信息"</span>);</span><br><span class="line">    plistDic.SetString(<span class="string">"NSLocationWhenInUseUsageDescription"</span>, <span class="string">"位置权限将会在您创建或加入房间后应用，允许使用后可查自己和房间中其他玩家的位置信息"</span>);</span><br><span class="line">    plistDic.SetString(<span class="string">"NSSiriUsageDescription"</span>, <span class="string">"是否允许Siri启动此App？"</span>);</span><br><span class="line">    <span class="comment">//其他功能</span></span><br><span class="line">    <span class="comment">//1.appstore内购</span></span><br><span class="line">    project.AddFrameworkToProject(target, <span class="string">"StoreKit.framework"</span>, <span class="literal">false</span>);</span><br><span class="line">    project.AddFrameworkToProject(target, <span class="string">"Foundation.framework"</span>, <span class="literal">false</span>);</span><br><span class="line">    CopyFileToXCodeProject(project, target, xcodePath, BuildTool.GetXcodeProDependentRootPath(), <span class="string">"Classes"</span>, <span class="string">"IAPInterface.h"</span>);</span><br><span class="line">    CopyFileToXCodeProject(project, target, xcodePath, BuildTool.GetXcodeProDependentRootPath(), <span class="string">"Classes"</span>, <span class="string">"IAPInterface.m"</span>);</span><br><span class="line">    CopyFileToXCodeProject(project, target, xcodePath, BuildTool.GetXcodeProDependentRootPath(), <span class="string">"Classes"</span>, <span class="string">"IAPManager.h"</span>);</span><br><span class="line">    CopyFileToXCodeProject(project, target, xcodePath, BuildTool.GetXcodeProDependentRootPath(), <span class="string">"Classes"</span>, <span class="string">"IAPManager.m"</span>);</span><br><span class="line">    <span class="comment">//2.截图保存到相册并刷新</span></span><br><span class="line">    plistDic.SetString(<span class="string">"NSPhotoLibraryAddUsageDescription"</span>, <span class="string">"沪乐麻将需要您的同意，才能访问您的相册用来存储游戏截图。"</span>);</span><br><span class="line">    CopyFileToXCodeProject(project, target, xcodePath, BuildTool.GetXcodeProDependentRootPath(), <span class="string">"Classes"</span>, <span class="string">"PhotoManager.h"</span>);</span><br><span class="line">    CopyFileToXCodeProject(project, target, xcodePath, BuildTool.GetXcodeProDependentRootPath(), <span class="string">"Classes"</span>, <span class="string">"PhotoManager.m"</span>);</span><br><span class="line">    <span class="comment">//3.网络状态监听</span></span><br><span class="line">    project.AddFrameworkToProject(target, <span class="string">"SystemConfiguration.framework"</span>, <span class="literal">false</span>);</span><br><span class="line">    CopyFileToXCodeProject(project, target, xcodePath, BuildTool.GetXcodeProDependentRootPath(), <span class="string">"Classes"</span>, <span class="string">"ReachabilityF.h"</span>);</span><br><span class="line">    CopyFileToXCodeProject(project, target, xcodePath, BuildTool.GetXcodeProDependentRootPath(), <span class="string">"Classes"</span>, <span class="string">"ReachabilityF.m"</span>);</span><br><span class="line">    <span class="comment">//4.应用内评分</span></span><br><span class="line">    <span class="comment">//StoreKit.framework Foundation.framework</span></span><br><span class="line">    CopyFileToXCodeProject(project, target, xcodePath, BuildTool.GetXcodeProDependentRootPath(), <span class="string">"Classes"</span>, <span class="string">"UnityStoreKit.h"</span>);</span><br><span class="line">    CopyFileToXCodeProject(project, target, xcodePath, BuildTool.GetXcodeProDependentRootPath(), <span class="string">"Classes"</span>, <span class="string">"UnityStoreKit.m"</span>);</span><br><span class="line">    <span class="comment">//5.点击空白区域关闭键盘</span></span><br><span class="line">    CopyFileToXCodeProject(project, target, xcodePath, BuildTool.GetXcodeProDependentRootPath(), <span class="string">"Classes/UI"</span>, <span class="string">"UnityView.h"</span>);</span><br><span class="line">    CopyFileToXCodeProject(project, target, xcodePath, BuildTool.GetXcodeProDependentRootPath(), <span class="string">"Classes/UI"</span>, <span class="string">"UnityView+iOS.mm"</span>);</span><br><span class="line">    <span class="comment">//7.重写下拉菜单</span></span><br><span class="line">    CopyFileToXCodeProject(project,target, xcodePath, BuildTool.GetXcodeProDependentRootPath(), <span class="string">"Classes/UI"</span>, <span class="string">"UnityViewControllerBase+iOS.mm"</span>);</span><br><span class="line">    <span class="comment">//8.通过URL打开APP</span></span><br><span class="line">    AddURLSchemes(plistDic, <span class="string">"fymj"</span>, <span class="string">"fengyeshanghaimajiang"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AddURLSchemes</span>(<span class="params">PlistElementDict plistDic, <span class="keyword">string</span> URLName, <span class="keyword">string</span> URLSchemes</span>)</span> &#123;</span><br><span class="line">    PlistElementArray urlTypes = <span class="literal">null</span>;</span><br><span class="line">     <span class="keyword">if</span> (plistDic.values.ContainsKey(<span class="string">"CFBundleURLTypes"</span>)) &#123;</span><br><span class="line">         urlTypes = plistDic[<span class="string">"CFBundleURLTypes"</span>].AsArray();</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">         urlTypes= plistDic.CreateArray(<span class="string">"CFBundleURLTypes"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">      </span><br><span class="line">    PlistElementDict itemDict = urlTypes.AddDict();</span><br><span class="line">    itemDict.SetString(<span class="string">"CFBundleTypeRole"</span>, <span class="string">"Editor"</span>);</span><br><span class="line">    itemDict.SetString(<span class="string">"CFBundleURLName"</span>, URLName);</span><br><span class="line">    PlistElementArray schemesArray1 = itemDict.CreateArray(<span class="string">"CFBundleURLSchemes"</span>);</span><br><span class="line">    schemesArray1.AddString(URLSchemes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AddQueriesSchemes</span>(<span class="params">PlistElementDict plistDic,<span class="keyword">string</span> urlName</span>)</span> &#123;</span><br><span class="line">    PlistElementArray queriesSchemes = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (plistDic.values.ContainsKey(<span class="string">"LSApplicationQueriesSchemes"</span>)) &#123;</span><br><span class="line">        queriesSchemes =plistDic[<span class="string">"LSApplicationQueriesSchemes"</span>].AsArray();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        queriesSchemes =plistDic.CreateArray(<span class="string">"LSApplicationQueriesSchemes"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    queriesSchemes.AddString(urlName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只支持创建一级目录 </span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CopyFileToXCodeProject</span>(<span class="params">PBXProject project,<span class="keyword">string</span> target,<span class="keyword">string</span> xcodePath,<span class="keyword">string</span> fileRootPath,<span class="keyword">string</span> floderName,<span class="keyword">string</span> fileFullName</span>)</span> &#123;</span><br><span class="line">    <span class="comment">//判断xcode工程是否存在这个目录</span></span><br><span class="line">    <span class="keyword">if</span> (!Directory.Exists(xcodePath + <span class="string">"/"</span> + floderName)) &#123;</span><br><span class="line">        Directory.CreateDirectory(xcodePath + <span class="string">"/"</span> + floderName);</span><br><span class="line">    &#125;</span><br><span class="line">    File.Copy(fileRootPath + <span class="string">"/"</span> + floderName + <span class="string">"/"</span> + fileFullName, xcodePath + <span class="string">"/"</span> + floderName + <span class="string">"/"</span> + fileFullName,<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">string</span> fileGuid =project.AddFile(xcodePath + <span class="string">"/"</span> + floderName + <span class="string">"/"</span> + fileFullName,  floderName +<span class="string">"/"</span> + fileFullName, PBXSourceTree.Source);</span><br><span class="line">    project.AddFileToBuild(target, fileGuid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AddLib</span>(<span class="params">PBXProject project,<span class="keyword">string</span> target,<span class="keyword">string</span> libName</span>)</span> &#123;</span><br><span class="line">    project.AddFileToBuild(target, project.AddFile(<span class="string">"usr/lib/"</span>+ libName, libName, PBXSourceTree.Sdk));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>调用sh脚本</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ExportIPA</span>(<span class="params"><span class="keyword">string</span> xcodeProjPath,<span class="keyword">string</span> exportOptionsPath</span>)</span> &#123;</span><br><span class="line">    DirectoryInfo dir = Directory.GetParent(Application.dataPath);</span><br><span class="line">    <span class="keyword">string</span> fileName = dir.ToString() + <span class="string">"/"</span> + <span class="string">"BuildTools"</span> + <span class="string">"/"</span> + <span class="string">"ExportIPA.sh"</span>;</span><br><span class="line">    <span class="keyword">string</span> arguments = fileName + <span class="string">" "</span> + xcodeProjPath + <span class="string">" "</span> + exportOptionsPath;</span><br><span class="line">    System.Diagnostics.Process process = <span class="keyword">new</span> System.Diagnostics.Process();</span><br><span class="line">    process.StartInfo.FileName = <span class="string">"/bin/bash"</span>;</span><br><span class="line">    process.StartInfo.Arguments = arguments;</span><br><span class="line">    process.StartInfo.CreateNoWindow = <span class="literal">false</span>; <span class="comment">// 获取或设置指示是否在新窗口中启动该进程的值（不想弹出powershell窗口看执行过程的话，就=true）</span></span><br><span class="line">    process.StartInfo.ErrorDialog = <span class="literal">true</span>; <span class="comment">// 该值指示不能启动进程时是否向用户显示错误对话框</span></span><br><span class="line">    process.StartInfo.UseShellExecute = <span class="literal">false</span>;</span><br><span class="line">    process.Start();</span><br><span class="line">    process.WaitForExit();</span><br><span class="line">    process.Close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>sh脚本内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">参数判断</span></span><br><span class="line">if [ $# != 2 ];then</span><br><span class="line">echo "需要输入xcode工程文件夹路径和ExportOptions.plist文件路径"</span><br><span class="line">exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">cd $1</span><br><span class="line"></span><br><span class="line">xcodebuild clean -project Unity-iPhone.xcodeproj -scheme Unity-iPhone -configuration Release</span><br><span class="line"></span><br><span class="line">xcodebuild archive -project Unity-iPhone.xcodeproj -scheme Unity-iPhone -archivePath $1/Unity-iPhone.xcarchive</span><br><span class="line"></span><br><span class="line">xcodebuild -exportArchive -exportOptionsPlist $2 -archivePath $1/Unity-iPhone.xcarchive -exportPath $1/Unity-iPhone.ipa</span><br><span class="line"></span><br><span class="line">open $1/Unity-iPhone.ipa</span><br></pre></td></tr></table></figure>
</li>
<li><p>Windows平台：导出为.zip</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">BuildPlayerOptions buildPlayerOptions = <span class="keyword">new</span> BuildPlayerOptions();</span><br><span class="line"><span class="keyword">string</span> dir = BuildTool.GetBuildPackageRootDir() + <span class="string">"/"</span> + <span class="string">"PC/"</span>;</span><br><span class="line"><span class="keyword">string</span> locationPathName = dir + BuildTool.GetPCPackageName();</span><br><span class="line">buildPlayerOptions.locationPathName = locationPathName;</span><br><span class="line">buildPlayerOptions.scenes = BuildTool.GetBuildScene();</span><br><span class="line">buildPlayerOptions.target = BuildTarget.StandaloneWindows;</span><br><span class="line">buildPlayerOptions.options = BuildOptions.None;</span><br><span class="line"></span><br><span class="line">BuildReport report = BuildPipeline.BuildPlayer(buildPlayerOptions);</span><br><span class="line">BuildSummary summary = report.summary;</span><br><span class="line"><span class="keyword">if</span> (summary.result == BuildResult.Succeeded) &#123;</span><br><span class="line">    Debug.Log(<span class="string">"Build succeeded: "</span> + summary.totalSize + <span class="string">" bytes"</span>);</span><br><span class="line">    <span class="comment">//需要压缩的文件</span></span><br><span class="line">    <span class="comment">//pc/ MonoBleedingEdge xxx_Data UnityCrashHandler32.exe UnityPlayer.dll xxx.exe MonoBleedingEdge</span></span><br><span class="line">    <span class="keyword">string</span> exePath = locationPathName;</span><br><span class="line">    <span class="keyword">string</span> dataPath =locationPathName.Replace(<span class="string">".exe"</span>,<span class="string">"_Data"</span>);</span><br><span class="line">    <span class="keyword">string</span> crashHandlePath =dir+ <span class="string">"UnityCrashHandler32.exe"</span>;</span><br><span class="line">    <span class="keyword">string</span> dllPath = dir+ <span class="string">"UnityPlayer.dll"</span>;</span><br><span class="line">    <span class="keyword">string</span> monoPath = dir + <span class="string">"MonoBleedingEdge"</span>;</span><br><span class="line">    <span class="comment">// 添加目录下的所有文件  </span></span><br><span class="line">    List&lt;<span class="keyword">string</span>&gt; files = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;();</span><br><span class="line">    files.Add(exePath);</span><br><span class="line">    files.Add(dataPath);</span><br><span class="line">    files.Add(crashHandlePath);</span><br><span class="line">    files.Add(dllPath);</span><br><span class="line">    files.Add(monoPath);</span><br><span class="line">    <span class="comment">//zip命名</span></span><br><span class="line">    <span class="keyword">string</span> archiveName = locationPathName.Replace(<span class="string">".exe"</span>, <span class="string">".zip"</span>);</span><br><span class="line">    <span class="comment">//使用Zip压缩工具压缩</span></span><br><span class="line">    ZipUtility.Zip(files.ToArray(), archiveName);</span><br><span class="line">    <span class="comment">//删除其他文件</span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> file <span class="keyword">in</span> files) &#123;</span><br><span class="line">        <span class="keyword">if</span> (File.Exists(file)) &#123;</span><br><span class="line">            File.Delete(file);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Directory.Exists(file)) &#123;</span><br><span class="line">            Directory.Delete(file,<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">        <span class="comment">//打开输出目录</span></span><br><span class="line">    BuildTool.OpenFolder(dir);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (summary.result == BuildResult.Failed) &#123;</span><br><span class="line">        Debug.Log(<span class="string">"Build failed"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>其他代码</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取当前编辑器选中的场景</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span>[] <span class="title">GetBuildScene</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    List&lt;<span class="keyword">string</span>&gt; scenePath = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;();</span><br><span class="line">    EditorBuildSettingsScene[] editorBuildSettingsScene = EditorBuildSettings.scenes;</span><br><span class="line">    <span class="keyword">if</span> (editorBuildSettingsScene != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> scene <span class="keyword">in</span> editorBuildSettingsScene) &#123;</span><br><span class="line">            scenePath.Add(scene.path);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> scenePath.ToArray();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//打开文件夹</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OpenFolder</span>(<span class="params"><span class="keyword">string</span> dir</span>)</span> &#123;</span><br><span class="line">    System.Diagnostics.ProcessStartInfo info = <span class="keyword">new</span> System.Diagnostics.ProcessStartInfo();</span><br><span class="line">    info.FileName = dir;<span class="comment">//打开工程所在目录</span></span><br><span class="line">    System.Diagnostics.Process.Start(info);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//获取sh脚本路径</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">GetIPAExportOptionsFilePath</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    DirectoryInfo dir = Directory.GetParent(Application.dataPath);</span><br><span class="line">    <span class="keyword">string</span> path = dir.ToString() + <span class="string">"/"</span> + <span class="string">"BuildTools"</span> + <span class="string">"/"</span> + <span class="string">"ExportOptions.plist"</span>;</span><br><span class="line">    <span class="keyword">return</span> path;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//获取XCode工程依赖文件（需要向新生成的Xcode工程中添加的资源或脚本）路径</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">GetXcodeProDependentRootPath</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    DirectoryInfo dir = Directory.GetParent(Application.dataPath);</span><br><span class="line">    <span class="keyword">string</span> rootDir = dir.ToString() + <span class="string">"/XCodeProDependent"</span>;</span><br><span class="line">    <span class="keyword">return</span> rootDir;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="七、使用Jenkins构建任务"><a href="#七、使用Jenkins构建任务" class="headerlink" title="七、使用Jenkins构建任务"></a>七、使用Jenkins构建任务</h2><ol>
<li>新建Item，设置General，可以添加描述，选择是否丢弃旧的构建，添加自定义参数等等<br><img src="/" alt="通用" class="lazyload" data-src="/posts/a27a69b1/%E9%80%9A%E7%94%A8.jpg"></li>
<li>配置源代码管理，SVN项目地址，连接凭证，我选择的是先还原再更新的方式<br><img src="/" alt="源代码管理" class="lazyload" data-src="/posts/a27a69b1/%E6%BA%90%E4%BB%A3%E7%A0%81%E7%AE%A1%E7%90%86.jpg"></li>
<li>构建触发器，当设置的条件满足时会自动进行构建<br><img src="/" alt="构建触发器" class="lazyload" data-src="/posts/a27a69b1/%E6%9E%84%E5%BB%BA%E8%A7%A6%E5%8F%91%E5%99%A8.jpg"></li>
<li>构建，可以选择你想用的方式进行构建，可使用bat命令、Shell命令、Unity编辑器命令等方式进行构建，编写命令时我们可以将General里面自定义的参数的和Jenkins提供给我们的参数添加到命令里面进行使用<br><img src="/" alt="使用自定义参数" class="lazyload" data-src="/posts/a27a69b1/%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8F%82%E6%95%B0.jpg"><br><img src="/" alt="打包" class="lazyload" data-src="/posts/a27a69b1/%E6%89%93%E5%8C%85.jpg"></li>
<li>构建后操作。构建完成后，我们可以归档生成的文件，如果有需要也可以在这里添加邮件通知<br><img src="/" alt="归档" class="lazyload" data-src="/posts/a27a69b1/%E5%BD%92%E6%A1%A3.jpg"></li>
</ol>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">tiger</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://chenghu.online/posts/a27a69b1/">https://chenghu.online/posts/a27a69b1/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://chenghu.online" target="_blank">tiger</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android</a><a class="post-meta__tags" href="/tags/Unity/">Unity</a><a class="post-meta__tags" href="/tags/iOS/">iOS</a><a class="post-meta__tags" href="/tags/Jenkins/">Jenkins</a></div><div class="post_share"><div class="social-share" data-image="https://s1.ax1x.com/2020/03/21/8fzFhT.jpg" data-sites="wechat,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/%E5%BE%AE%E4%BF%A1.png" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/%E6%94%AF%E4%BB%98%E5%AE%9D.png" alt="支付宝"/><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/posts/cf36b965/"><img class="prev_cover lazyload" data-src="https://s1.ax1x.com/2020/03/21/8fzFhT.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Unity 图集优化</div></div></a></div><div class="next-post pull_right"><a href="/posts/fb902642/"><img class="next_cover lazyload" data-src="https://s2.ax1x.com/2020/03/09/89wSaj.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Unity 调用iOS原生实现内购</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/posts/bb35cfaa/" title="你的项目中是否还在使用HTTP而非HPPTS"><img class="relatedPosts_cover lazyload"data-src="https://s2.ax1x.com/2020/02/25/3YGU56.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-02-25</div><div class="relatedPosts_title">你的项目中是否还在使用HTTP而非HPPTS</div></div></a></div><div class="relatedPosts_item"><a href="/posts/3549087f/" title="AppStore上架：未使用iOS原生实现内购"><img class="relatedPosts_cover lazyload"data-src="https://s2.ax1x.com/2020/02/22/3MrXrj.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-02-23</div><div class="relatedPosts_title">AppStore上架：未使用iOS原生实现内购</div></div></a></div><div class="relatedPosts_item"><a href="/posts/e05b8785/" title="Unity 导出为XCode工程后无法选择iPhone模拟器运行"><img class="relatedPosts_cover lazyload"data-src="https://s2.ax1x.com/2020/02/19/3VHDLF.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-02-19</div><div class="relatedPosts_title">Unity 导出为XCode工程后无法选择iPhone模拟器运行</div></div></a></div><div class="relatedPosts_item"><a href="/posts/fb902642/" title="Unity 调用iOS原生实现内购"><img class="relatedPosts_cover lazyload"data-src="https://s2.ax1x.com/2020/03/09/89wSaj.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-09</div><div class="relatedPosts_title">Unity 调用iOS原生实现内购</div></div></a></div><div class="relatedPosts_item"><a href="/posts/a4887a20/" title="Android系统版本与API等级对照表"><img class="relatedPosts_cover lazyload"data-src="https://s2.ax1x.com/2020/02/28/3BXigf.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-02-28</div><div class="relatedPosts_title">Android系统版本与API等级对照表</div></div></a></div><div class="relatedPosts_item"><a href="/posts/decfd98d/" title="Android SDKManager无法正常升级SDK"><img class="relatedPosts_cover lazyload"data-src="https://s2.ax1x.com/2020/02/19/3VFMaq.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-02-16</div><div class="relatedPosts_title">Android SDKManager无法正常升级SDK</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div class="vcomment" id="vcomment"></div><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;

window.valine = new Valine({
  el:'#vcomment',
  notify: false,
  verify: false,
  appId: 'tQ90OYDbWhrYRbMgHxjKHn7Q-9Nh9j0Va',
  appKey: 'POr9AtbyNKNVnMKEAk0vd5Pz',
  placeholder: '记得留下你的昵称和邮箱...可以快速收到回复',
  avatar: 'monsterid',
  meta: guest_info,
  pageSize: '10',
  lang: 'zh-cn',
  recordIP: false,
  serverURLs: ''
});</script></div></article></main><footer id="footer" style="background-image: url(https://s1.ax1x.com/2020/03/12/8eGq29.jpg)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By tiger</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script id="ribbon_piao" mobile="true" src="/js/third-party/piao.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>