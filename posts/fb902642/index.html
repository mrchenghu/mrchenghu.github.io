<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>Unity调用iOS原生实现内购 | tiger</title><meta name="description" content="Unity调用iOS原生实现内购"><meta name="keywords" content="Unity,iOS,AppStore"><meta name="author" content="tiger"><meta name="copyright" content="tiger"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/my_favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Unity调用iOS原生实现内购"><meta name="twitter:description" content="Unity调用iOS原生实现内购"><meta name="twitter:image" content="https://s2.ax1x.com/2020/03/09/89wSaj.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Unity调用iOS原生实现内购"><meta property="og:url" content="https://chenghu.online/posts/fb902642/"><meta property="og:site_name" content="tiger"><meta property="og:description" content="Unity调用iOS原生实现内购"><meta property="og:image" content="https://s2.ax1x.com/2020/03/09/89wSaj.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = '1'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://chenghu.online/posts/fb902642/"><link rel="next" title="Unity FairyGUI适配" href="https://chenghu.online/posts/3d5e8524/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://chenghu.online/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="tiger" type="application/atom+xml">
</head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">tiger</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-coffee"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 更多</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></span><span class="pull_right" id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/my_avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">15</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">7</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">6</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-coffee"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 更多</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div></div><div id="body-wrap"><div id="web_bg" data-type="color"></div><main id="content-outer"><div id="top-container" style="background-image: url(https://s2.ax1x.com/2020/03/09/89wSaj.jpg)"><div id="post-info"><div id="post-title"><div class="posttitle">Unity调用iOS原生实现内购</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 发表于 2020-03-09<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> 更新于 2020-03-12</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%AE%A1%E6%A0%B8%E6%97%A5%E8%AE%B0/">审核日记</a></span><div class="post-meta-wordcount"><div class="post-meta-pv-cv"><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>阅读量:</span><span id="busuanzi_value_page_pv"></span></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><html><head></head><body><h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>前面我写了一篇文章：<a href="/posts/3549087f/" title="AppStore上架：未使用iOS原生实现内购">AppStore上架：未使用iOS原生实现内购</a>，说明了为什么最好使用原生代码实现内购，所以本篇便是介绍如何代码实现！我在代码中做了漏单处理，我们需要尽早的监听付款队列，并且要等后端验证完成后才可以结束这笔交易。因为在app启动后，系统会检查是否有未完成的交易，或者新的续订，如果有的话会加入交易队列。所以如果我们在app启动后没有及时添加监听或者监听后没有处理未完成的交易，就会造成漏单。如果我们在后端没有完成验证的情况下结束了正在进行的交易，但是不巧的是后端并没有收到你的请求，同样会造成漏单。</p>
<h2 id="具体步骤"><a href="#具体步骤" class="headerlink" title="具体步骤"></a>具体步骤</h2><p>在XCode工程中添加内购代码<br>1.添加IAPManager.h文件</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">objc</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight objc"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">< Foundation/Foundation.h ></span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">< StoreKit/StoreKit.h ></span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">IAPManager</span> : <span class="title">NSObject</span><<span class="title">SKProductsRequestDelegate</span>, <span class="title">SKPaymentTransactionObserver</span>></span>{</span><br><span class="line">    <span class="built_in">SKProduct</span> *proUpgradeProduct;</span><br><span class="line">    <span class="built_in">SKProductsRequest</span> *productsRequest;</span><br><span class="line">    <span class="built_in">NSString</span> *productIndentify;</span><br><span class="line">}</span><br><span class="line">-(<span class="keyword">void</span>)attachObserver; <span class="comment">// 监听付款队列</span></span><br><span class="line">-(<span class="built_in">BOOL</span>)CanMakePayment; <span class="comment">// 判断是否可以付款</span></span><br><span class="line">-(<span class="keyword">void</span>)requestProductData:(<span class="built_in">NSString</span> *)productIdentifiers; <span class="comment">// 获取这个ID的商品信息</span></span><br><span class="line">-(<span class="keyword">void</span>)buyRequest:(<span class="built_in">NSString</span> *)productIdentifier; <span class="comment">// 请求购买这个ID的商品</span></span><br><span class="line">-(<span class="keyword">void</span>)InitWatting; <span class="comment">// 初始化等待遮罩</span></span><br><span class="line">-(<span class="keyword">void</span>)gameServerSendProductEnd:(<span class="built_in">NSString</span> *)transactionID; <span class="comment">// 后端验证购买完成后的回调</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></tbody></table></figure></div>
<p>2.添加IAPManager.m</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">objc</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight objc"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"IAPManager.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 弹窗和等待遮罩</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">IAPManager</span></span></span><br><span class="line">{</span><br><span class="line">    <span class="built_in">UIView</span>  *_viewBg;</span><br><span class="line">    <span class="built_in">UIView</span>  *_viewBorder;</span><br><span class="line">    <span class="built_in">UIActivityIndicatorView</span> * _activityIndicator;</span><br><span class="line">    <span class="built_in">UIWindow</span> *_window;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>) attachObserver{</span><br><span class="line">    [[<span class="built_in">SKPaymentQueue</span> defaultQueue] addTransactionObserver:<span class="keyword">self</span>];</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">-(<span class="built_in">BOOL</span>) CanMakePayment{</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">SKPaymentQueue</span> canMakePayments];</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>) requestProductData:(<span class="built_in">NSString</span> *)productIdentifiers{</span><br><span class="line">    <span class="built_in">NSArray</span> *idArray = [productIdentifiers componentsSeparatedByString:<span class="string">@"\t"</span>];    <span class="built_in">NSSet</span> *idSet = [<span class="built_in">NSSet</span> setWithArray:idArray];</span><br><span class="line">    [<span class="keyword">self</span> sendRequest:idSet];</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)sendRequest:(<span class="built_in">NSSet</span> *)idSet{</span><br><span class="line">    <span class="built_in">SKProductsRequest</span> *request = [[<span class="built_in">SKProductsRequest</span> alloc] initWithProductIdentifiers:idSet];</span><br><span class="line">    request.delegate = <span class="keyword">self</span>;</span><br><span class="line">    [request start];</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)productsRequest:(<span class="built_in">SKProductsRequest</span> *)request didReceiveResponse:(<span class="built_in">SKProductsResponse</span> *)response{</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSArray</span> *products = response.products;</span><br><span class="line">    <span class="comment">// populate UI</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">SKProduct</span> *p <span class="keyword">in</span> products) {</span><br><span class="line">        <span class="comment">// 将获取到的商品信息回传给Unity</span></span><br><span class="line">        UnitySendMessage(<span class="string">"IOSIAPMgr"</span>, <span class="string">"ShowProductList"</span>, [[<span class="keyword">self</span> productInfo:p] UTF8String]);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)buyRequest:(<span class="built_in">NSString</span> *)productIdentifier{</span><br><span class="line">    productIndentify=productIdentifier;</span><br><span class="line">    <span class="built_in">SKPayment</span> *payment = [<span class="built_in">SKPayment</span> paymentWithProductIdentifier:productIdentifier];</span><br><span class="line">    [[<span class="built_in">SKPaymentQueue</span> defaultQueue] addPayment:payment];</span><br><span class="line">    [<span class="keyword">self</span> showWatting];</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">-(<span class="built_in">NSString</span> *)productInfo:(<span class="built_in">SKProduct</span> *)product{</span><br><span class="line">    <span class="built_in">NSArray</span> *info = [<span class="built_in">NSArray</span> arrayWithObjects:product.localizedTitle,product.localizedDescription,product.price,product.productIdentifier, <span class="literal">nil</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> [info componentsJoinedByString:<span class="string">@"\t"</span>];</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"> <span class="comment">//创建一个空字典，保存正在进行的交易</span></span><br><span class="line"> <span class="built_in">NSMutableArray</span>*transArray;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  验证购买，避免非正常购买问题</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">-(<span class="keyword">void</span>)verifyPurchaseWithPaymentTransaction:(<span class="built_in">SKPaymentTransaction</span>*)tran{</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">NSURL</span> *receiptUrl=[[<span class="built_in">NSBundle</span> mainBundle] appStoreReceiptURL];</span><br><span class="line">    <span class="built_in">NSData</span> *receiptData=[<span class="built_in">NSData</span> dataWithContentsOfURL:receiptUrl];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSString</span> *receiptString=[receiptData base64EncodedStringWithOptions:<span class="built_in">NSDataBase64EncodingEndLineWithLineFeed</span>];<span class="comment">//转化为base64字符串</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">//除去receiptdata中的特殊字符</span></span><br><span class="line">    <span class="built_in">NSString</span> *receipt1=[receiptString stringByReplacingOccurrencesOfString:<span class="string">@"\\n"</span> withString:<span class="string">@""</span>];</span><br><span class="line">    <span class="built_in">NSString</span> *receipt2=[receipt1 stringByReplacingOccurrencesOfString:<span class="string">@"\\r"</span> withString:<span class="string">@""</span>];</span><br><span class="line">    <span class="built_in">NSString</span> *receipt3=[receipt2 stringByReplacingOccurrencesOfString:<span class="string">@"%2B"</span> withString:<span class="string">@"+"</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *mdic =[<span class="built_in">NSMutableDictionary</span> dictionaryWithObject:tran.transactionIdentifier forKey:<span class="string">@"TransactionID"</span>];</span><br><span class="line">    [mdic setObject:receipt3 forKey:<span class="string">@"Payload"</span>];</span><br><span class="line">    <span class="built_in">NSData</span> *data=[<span class="built_in">NSJSONSerialization</span> dataWithJSONObject:mdic options:<span class="built_in">NSJSONWritingPrettyPrinted</span> error:<span class="literal">nil</span>];</span><br><span class="line">    <span class="built_in">NSString</span> *str=[[<span class="built_in">NSString</span> alloc]initWithData:data encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 保存正在进行的交易</span></span><br><span class="line">    <span class="keyword">if</span> (transArray==<span class="literal">nil</span>) {</span><br><span class="line">        transArray=[<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    }</span><br><span class="line">    [transArray addObject:tran];</span><br><span class="line">    <span class="comment">// 通知Unity购买成功，将数据交由后端去苹果后台进行验证</span></span><br><span class="line">    UnitySendMessage(<span class="string">"IOSIAPMgr"</span>, <span class="string">"BuyProductSucessCallBack"</span>, str.UTF8String);</span><br><span class="line">}</span><br><span class="line"><span class="comment">//交易结果返回，根据状态进行不同的处理</span></span><br><span class="line">- (<span class="keyword">void</span>)paymentQueue:(<span class="built_in">SKPaymentQueue</span> *)queue updatedTransactions:(<span class="built_in">NSArray</span> *)transaction{</span><br><span class="line">    <span class="keyword">for</span>(<span class="built_in">SKPaymentTransaction</span> *tran <span class="keyword">in</span> transaction){</span><br><span class="line">        <span class="keyword">switch</span> (tran.transactionState) {</span><br><span class="line">            <span class="keyword">case</span> <span class="built_in">SKPaymentTransactionStatePurchased</span>:{</span><br><span class="line">                <span class="comment">// 进行验证</span></span><br><span class="line">                [<span class="keyword">self</span> verifyPurchaseWithPaymentTransaction:tran];</span><br><span class="line">            }</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="built_in">SKPaymentTransactionStatePurchasing</span>:{</span><br><span class="line">                [<span class="keyword">self</span> showWatting];</span><br><span class="line">            }</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="built_in">SKPaymentTransactionStateRestored</span>:{</span><br><span class="line">                [[<span class="built_in">SKPaymentQueue</span> defaultQueue] finishTransaction:tran];</span><br><span class="line">                [<span class="keyword">self</span> hideWatting];</span><br><span class="line">            }</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="built_in">SKPaymentTransactionStateFailed</span>:{</span><br><span class="line">                <span class="comment">// 弹窗提示交易失败</span></span><br><span class="line">                <span class="built_in">UIAlertController</span> *alertview=[<span class="built_in">UIAlertController</span> alertControllerWithTitle:<span class="string">@"交易提示"</span> message:<span class="string">@"交易失败"</span> preferredStyle:<span class="built_in">UIAlertControllerStyleAlert</span>];</span><br><span class="line">                <span class="built_in">UIAlertAction</span> *defult = [<span class="built_in">UIAlertAction</span> actionWithTitle:<span class="string">@"确定"</span> style:<span class="built_in">UIAlertActionStyleDefault</span> handler:<span class="literal">nil</span>];</span><br><span class="line">                [alertview addAction:defult];</span><br><span class="line">                <span class="keyword">if</span> (_window==<span class="literal">nil</span>) {</span><br><span class="line">                     _window = [<span class="built_in">UIApplication</span> sharedApplication].keyWindow;</span><br><span class="line">                }</span><br><span class="line">                [_window.rootViewController presentViewController:alertview animated:<span class="literal">YES</span> completion:<span class="literal">nil</span>];</span><br><span class="line">                <span class="comment">// 结束这笔交易</span></span><br><span class="line">                [[<span class="built_in">SKPaymentQueue</span> defaultQueue] finishTransaction:tran];</span><br><span class="line">                [<span class="keyword">self</span> hideWatting];</span><br><span class="line">            }</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">            {</span><br><span class="line">                [[<span class="built_in">SKPaymentQueue</span> defaultQueue] finishTransaction:tran];</span><br><span class="line">                [<span class="keyword">self</span> showWatting];</span><br><span class="line">            }</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)gameServerSendProductEnd:(<span class="built_in">NSString</span> *)transactionID;{</span><br><span class="line">    <span class="comment">//订单数组为空或者没有，返回</span></span><br><span class="line">    <span class="keyword">if</span> (transArray==<span class="literal">nil</span>||transArray.count==<span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//遍历订单数组，将服务端处理完成的订单移除</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i<[transArray count]; i++) {</span><br><span class="line">       <span class="built_in">SKPaymentTransaction</span>*tran  = transArray[i];</span><br><span class="line">        <span class="keyword">if</span> ([tran.transactionIdentifier isEqualToString:transactionID ]) {</span><br><span class="line">            [transArray removeObject:tran];</span><br><span class="line">            [[<span class="built_in">SKPaymentQueue</span> defaultQueue] finishTransaction:tran];</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//如果订单数组的元素个数为0.证明当前订单已全部处理完成，关闭等待UI</span></span><br><span class="line">    <span class="keyword">if</span> (transArray.count==<span class="number">0</span>) {</span><br><span class="line">        [<span class="keyword">self</span> hideWatting];</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)showWatting{</span><br><span class="line">    </span><br><span class="line">    [_activityIndicator startAnimating];</span><br><span class="line">    [_window addSubview:_viewBg];</span><br><span class="line">    </span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)hideWatting{</span><br><span class="line">    </span><br><span class="line">    [_activityIndicator stopAnimating];</span><br><span class="line">    [_viewBg removeFromSuperview];</span><br><span class="line">  </span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)InitWatting{</span><br><span class="line">    </span><br><span class="line">    _window = [<span class="built_in">UIApplication</span> sharedApplication].keyWindow;</span><br><span class="line">    </span><br><span class="line">    _viewBg = [[<span class="built_in">UIView</span> alloc ] initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">0</span>,<span class="number">0</span>, <span class="built_in">UIScreen</span>.mainScreen.bounds.size.width,<span class="built_in">UIScreen</span>.mainScreen.bounds.size.height)];</span><br><span class="line">    _viewBg.backgroundColor=[<span class="built_in">UIColor</span> colorWithRed:<span class="number">0</span> green:<span class="number">0</span> blue:<span class="number">0</span> alpha:<span class="number">0.01</span>];</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    _viewBorder = [[<span class="built_in">UIView</span> alloc ] initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">100</span>,<span class="number">100</span>)];</span><br><span class="line">    [_viewBg addSubview:_viewBorder];</span><br><span class="line">    </span><br><span class="line">    _viewBorder.center= <span class="built_in">CGPointMake</span>(_viewBg.frame.size.width/<span class="number">2.0</span> ,_viewBg.frame.size.height/<span class="number">2.0</span>);</span><br><span class="line">    _viewBorder.backgroundColor =[<span class="built_in">UIColor</span> colorWithRed:<span class="number">0</span> green:<span class="number">0</span> blue:<span class="number">0</span> alpha:<span class="number">0.9</span>];</span><br><span class="line">    _viewBorder.layer.cornerRadius=<span class="number">8</span>;</span><br><span class="line">    _viewBorder.layer.masksToBounds=<span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    _activityIndicator = [[<span class="built_in">UIActivityIndicatorView</span> alloc]initWithActivityIndicatorStyle:<span class="built_in">UIActivityIndicatorViewStyleWhiteLarge</span>];</span><br><span class="line">    [_viewBorder addSubview:_activityIndicator];</span><br><span class="line">    </span><br><span class="line">    _activityIndicator.frame= <span class="built_in">CGRectMake</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">200</span>,<span class="number">200</span>);</span><br><span class="line">    _activityIndicator.center= <span class="built_in">CGPointMake</span>(_viewBorder.frame.size.width/<span class="number">2.0</span> ,_viewBorder.frame.size.height/<span class="number">2.0</span>);</span><br><span class="line">    _activityIndicator.hidesWhenStopped = <span class="literal">NO</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></tbody></table></figure></div>
<p>在XCode中添加和Unity交互的代码<br>1.IAPInterface.h</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">objc</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight objc"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">< Foundation/Foundation.h ></span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">IAPInterface</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></tbody></table></figure></div>
<p>2.IAPInterface.m</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">objc</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight objc"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"IAPInterface.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"IAPManager.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">IAPInterface</span></span></span><br><span class="line"><span class="meta">#if defined (__cplusplus)</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span></span><br><span class="line">{</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">    IAPManager *iapManager = <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">//初始化</span></span><br><span class="line">    <span class="keyword">void</span> InitIAPManager(){</span><br><span class="line">        iapManager = [[IAPManager alloc] init];</span><br><span class="line">        [iapManager attachObserver];</span><br><span class="line">        [iapManager InitWatting];</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//判断是否可以购买</span></span><br><span class="line">    <span class="keyword">bool</span> IsProductAvailable(){</span><br><span class="line">        <span class="keyword">return</span> [iapManager CanMakePayment];</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//获取商品信息</span></span><br><span class="line">    <span class="keyword">void</span> RequstProductInfo(<span class="keyword">char</span> *p){</span><br><span class="line">        <span class="built_in">NSString</span> *list = [<span class="built_in">NSString</span> stringWithUTF8String:p];</span><br><span class="line">        [iapManager requestProductData:list];</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//购买商品</span></span><br><span class="line">    <span class="keyword">void</span> BuyProduct(<span class="keyword">char</span> *p){</span><br><span class="line">        [iapManager buyRequest:[<span class="built_in">NSString</span> stringWithUTF8String:p]];</span><br><span class="line">    }</span><br><span class="line">	<span class="comment">//游戏服务端发货完成移除订单</span></span><br><span class="line">    <span class="keyword">void</span> GameServerSendProductEnd(<span class="keyword">char</span> *p){</span><br><span class="line">	<span class="keyword">return</span> [iapManager gameServerSendProductEnd:[<span class="built_in">NSString</span> stringWithUTF8String:p]];</span><br><span class="line">    }</span><br><span class="line"><span class="meta">#if defined (__cplusplus)</span></span><br><span class="line">}</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></tbody></table></figure></div>
<p>在Unity中添加和iOS交互的代码</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c#</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c#"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">IOSIAPMgr</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">{</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> UNITY_IOS</span></span><br><span class="line">    <span class="keyword">private</span> List<<span class="keyword">string</span>> productInfo = <span class="keyword">new</span> List<<span class="keyword">string</span>>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> IOSIAPMgr _instance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> IOSIAPMgr Instance{</span><br><span class="line">        <span class="keyword">get</span>{</span><br><span class="line">            <span class="keyword">if</span>(_instance==<span class="literal">null</span>)</span><br><span class="line">            {</span><br><span class="line">             GameObject go=<span class="keyword">new</span> GameObject(<span class="string">"IOSIAPMgr"</span>);</span><br><span class="line">             DontDestroyOnLoad (go);</span><br><span class="line">             _instance=go.AddComponent<iosiapmgr>();</iosiapmgr></span><br><span class="line"></span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> _instance;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    {</span><br><span class="line">        <span class="keyword">if</span>(_instance==<span class="literal">null</span>){</span><br><span class="line">           _instance = <span class="keyword">this</span>;</span><br><span class="line">        }</span><br><span class="line">        _instance.Init();</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    [<span class="meta">DllImport(<span class="meta-string">"__Internal"</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">InitIAPManager</span>(<span class="params"></span>)</span>;<span class="comment">//初始化</span></span><br><span class="line">    </span><br><span class="line">    [<span class="meta">DllImport(<span class="meta-string">"__Internal"</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">bool</span> <span class="title">IsProductAvailable</span>(<span class="params"></span>)</span>;<span class="comment">//判断是否可以购买</span></span><br><span class="line">    </span><br><span class="line">    [<span class="meta">DllImport(<span class="meta-string">"__Internal"</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">RequstProductInfo</span>(<span class="params"><span class="keyword">string</span> s</span>)</span>;<span class="comment">//获取商品信息</span></span><br><span class="line">    </span><br><span class="line">    [<span class="meta">DllImport(<span class="meta-string">"__Internal"</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">BuyProduct</span>(<span class="params"><span class="keyword">string</span> s</span>)</span>;<span class="comment">//购买商品</span></span><br><span class="line"></span><br><span class="line">    [<span class="meta">DllImport(<span class="meta-string">"__Internal"</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">GameServerSendProductEnd</span>(<span class="params"><span class="keyword">string</span> transactionID</span>)</span>;<span class="comment">//游戏后端验证完成回调</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//展示商品信息</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">ShowProductList</span>(<span class="params"><span class="keyword">string</span> s</span>)</span>{</span><br><span class="line">        productInfo.Add(s);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span>  <span class="keyword">void</span> <span class="title">Init</span> (<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    {</span><br><span class="line">        <span class="keyword">if</span> (Application.platform==RuntimePlatform.IPhonePlayer) {</span><br><span class="line">            InitIAPManager();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">IsProductVailable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    {</span><br><span class="line">        <span class="keyword">return</span> IsProductAvailable();</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//根据商品ID请求商品信息</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RequstALLProductInfo</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    {</span><br><span class="line">        <span class="keyword">if</span>(IsProductAvailable())</span><br><span class="line">        {</span><br><span class="line">            RequstProductInfo(<span class="string">"your ProductID"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">IAPBuyProduct</span>(<span class="params"><span class="keyword">string</span> str</span>)</span></span><br><span class="line"><span class="function"></span>    {</span><br><span class="line">        <span class="keyword">if</span> (IsProductAvailable())</span><br><span class="line">        {</span><br><span class="line">            BuyProduct(str);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// IOS 购买商品成功的回调</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">BuyProductSucessCallBack</span>(<span class="params"><span class="keyword">string</span> args</span>)</span></span><br><span class="line"><span class="function"></span>    {</span><br><span class="line">        IOSIAPJson json =LitJson.JsonMapper.ToObject<iosiapjson>(args);</iosiapjson></span><br><span class="line">        ProductsArray.Add(json);</span><br><span class="line">        SendProductsToServer();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List<iosiapjson> ProductsArray=<span class="keyword">new</span> List<iosiapjson>();</iosiapjson></iosiapjson></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendProductsToServer</span>(<span class="params"></span>)</span> {</span><br><span class="line">        <span class="keyword">if</span> (cor!=<span class="literal">null</span>) {</span><br><span class="line">            StopCoroutine(cor);</span><br><span class="line">        }</span><br><span class="line">        cor = StartCoroutine(ieSendProductsToServer());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Coroutine cor;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//开启协程。每过一分钟检查一次是否有未完成的订单</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> IEnumerator <span class="title">ieSendProductsToServer</span>(<span class="params"></span>)</span> {</span><br><span class="line">        <span class="keyword">while</span> (ProductsArray != <span class="literal">null</span>&& ProductsArray.Count><span class="number">0</span>) {</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> product <span class="keyword">in</span> ProductsArray) {</span><br><span class="line">                <span class="keyword">string</span> json = LitJson.JsonMapper.ToJson(product);</span><br><span class="line">                FYMJ.Guide.Service.GuideServiceRequest.Instance().FangKaBack(json);</span><br><span class="line">            }</span><br><span class="line">            <span class="function"><span class="keyword">yield</span> return new <span class="title">WaitForSeconds</span>(<span class="params"><span class="number">60f</span></span>)</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 后端验证完成，返回交易的ID</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ServerCallBack</span>(<span class="params">AnyString transactionID</span>)</span> {</span><br><span class="line">       <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(transactionID)) {</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i < ProductsArray.Count; i++) {</span><br><span class="line">                IOSIAPJson json = ProductsArray[i];</span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(json.TransactionID)&&json.TransactionID==transactionID) {</span><br><span class="line">                    ProductsArray.RemoveAt(i);</span><br><span class="line">                    i--;</span><br><span class="line">                    GameServerSendProductEnd(transactionID);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">       }</span><br><span class="line">    }</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h2><ol>
<li>等待遮罩是为了玩家频繁下单，可以按需修改</li>
<li>请求商品信息部分我没有用到，看上去没什么用</li>
<li>协程循环发送未完成的交易，可以删除价值不大</li>
<li>上架前和上架后，拉起的支付页面长得不太一样</li>
</ol>
<p>文章内容参考了<a href="https://www.cnblogs.com/weiqiangwaideshijie/p/9103407.html" target="_blank" rel="noopener">博客园-墙外的世界</a>，不用于商业用途，如有侵权请联系，我将尽快删除。</p>
</body></html></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">tiger</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://chenghu.online/posts/fb902642/">https://chenghu.online/posts/fb902642/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://chenghu.online">tiger</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Unity/">Unity    </a><a class="post-meta__tags" href="/tags/iOS/">iOS    </a><a class="post-meta__tags" href="/tags/AppStore/">AppStore    </a></div><div class="post_share"><div class="social-share" data-image="https://s2.ax1x.com/2020/03/09/89wSaj.jpg" data-sites="wechat,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/%E5%BE%AE%E4%BF%A1.png" alt="微信"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/%E6%94%AF%E4%BB%98%E5%AE%9D.png" alt="支付宝"><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="next-post pull-full"><a href="/posts/3d5e8524/"><img class="next_cover lazyload" data-src="https://s2.ax1x.com/2020/03/09/89lMGQ.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>Unity FairyGUI适配</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/posts/3549087f/" title="AppStore上架：未使用iOS原生实现内购"><img class="relatedPosts_cover lazyload"data-src="https://s2.ax1x.com/2020/02/22/3MrXrj.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-02-23</div><div class="relatedPosts_title">AppStore上架：未使用iOS原生实现内购</div></div></a></div><div class="relatedPosts_item"><a href="/posts/e05b8785/" title="Unity导出为XCode工程后无法选择iPhone模拟器运行"><img class="relatedPosts_cover lazyload"data-src="https://s2.ax1x.com/2020/02/19/3VHDLF.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-02-19</div><div class="relatedPosts_title">Unity导出为XCode工程后无法选择iPhone模拟器运行</div></div></a></div><div class="relatedPosts_item"><a href="/posts/bb35cfaa/" title="你的项目中是否还在使用HTTP而非HPPTS"><img class="relatedPosts_cover lazyload"data-src="https://s2.ax1x.com/2020/02/25/3YGU56.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-02-25</div><div class="relatedPosts_title">你的项目中是否还在使用HTTP而非HPPTS</div></div></a></div><div class="relatedPosts_item"><a href="/posts/3d5e8524/" title="Unity FairyGUI适配"><img class="relatedPosts_cover lazyload"data-src="https://s2.ax1x.com/2020/03/09/89lMGQ.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-09</div><div class="relatedPosts_title">Unity FairyGUI适配</div></div></a></div><div class="relatedPosts_item"><a href="/posts/128d17a7/" title="Unity UGUI适配"><img class="relatedPosts_cover lazyload"data-src="https://s2.ax1x.com/2020/03/03/3horhF.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-02</div><div class="relatedPosts_title">Unity UGUI适配</div></div></a></div><div class="relatedPosts_item"><a href="/posts/1fc8603e/" title="Unity日志可视化插件LogViewer"><img class="relatedPosts_cover lazyload"data-src="https://s2.ax1x.com/2020/02/28/3D3bGj.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-02-28</div><div class="relatedPosts_title">Unity日志可视化插件LogViewer</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div class="vcomment" id="vcomment"></div><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = false == true ? true : false;
var verify = false == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;

window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'tQ90OYDbWhrYRbMgHxjKHn7Q-9Nh9j0Va',
  appKey:'POr9AtbyNKNVnMKEAk0vd5Pz',
  placeholder:'记得留下你的昵称和邮箱...可以快速收到回复',
  avatar:'monsterid',
  guest_info:guest_info,
  pageSize:'10',
  lang:'zh-cn',
  recordIP: true
});</script></div></div></main><footer id="footer" style="background-image: url(https://s2.ax1x.com/2020/03/09/89wSaj.jpg)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By tiger</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>